<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskVault - Your Secondary Brain</title>
    <meta name="description" content="Store and organize links, images, and contextual information with deadline tracking">
    <meta name="theme-color" content="#1E90FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TaskVault">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon-192.svg" type="image/svg+xml">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .task-item { transition: all 0.2s ease; }
        .task-item:hover { transform: translateY(-1px); }
        .completed { opacity: 0.6; }
        .completed .task-title { text-decoration: line-through; }
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }
        .overdue { background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%); border-color: #fca5a5; }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .tag { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 12px; font-size: 12px; }
        .floating-add { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
        .undo-toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 60; }
        .recording { animation: recordPulse 1s infinite; }
        @keyframes recordPulse { 0%, 100% { background-color: #ef4444; } 50% { background-color: #dc2626; } }
        .share-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 70; }
        .install-prompt { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 60; }
        .clipboard-area { 
            border: 2px dashed #ccc; 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center; 
            background: #f9f9f9;
            transition: all 0.3s ease;
        }
        .clipboard-area.dragover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .clipboard-area.focused {
            border-color: #007bff;
            background: #f0f8ff;
        }
        .safari-paste-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }
        .paste-button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
        }
        .paste-button:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004494 100%);
        }
        .url-display {
            word-break: break-all;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script>
        const { useState, useEffect, createElement: e, useRef } = React;
        
        // Safari detection
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // PWA Installation Manager
        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('ðŸ’¾ PWA install prompt available');
        });
        
        window.addEventListener('appinstalled', (e) => {
            console.log('âœ… PWA installed successfully');
            deferredPrompt = null;
        });
        
        // Enhanced Local Storage Manager
        class TaskStorage {
            constructor() {
                this.storageKey = 'taskvault-tasks';
                this.settingsKey = 'taskvault-settings';
                this.undoKey = 'taskvault-undo';
                this.tasks = this.loadTasks();
                this.settings = this.loadSettings();
                this.undoStack = this.loadUndoStack();
                this.nextId = Math.max(...this.tasks.map(t => t.id), 0) + 1;
            }
            
            loadTasks() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    return [];
                }
            }
            
            loadSettings() {
                try {
                    const stored = localStorage.getItem(this.settingsKey);
                    return stored ? JSON.parse(stored) : {};
                } catch (error) {
                    return {};
                }
            }
            
            loadUndoStack() {
                try {
                    const stored = localStorage.getItem(this.undoKey);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    return [];
                }
            }
            
            saveTasks() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.tasks));
            }
            
            saveSettings() {
                localStorage.setItem(this.settingsKey, JSON.stringify(this.settings));
            }
            
            saveUndoStack() {
                this.undoStack = this.undoStack.slice(-10);
                localStorage.setItem(this.undoKey, JSON.stringify(this.undoStack));
            }
            
            addToUndoStack(action, data) {
                this.undoStack.push({
                    action,
                    data,
                    timestamp: Date.now()
                });
                this.saveUndoStack();
            }
            
            getAllTasks() {
                return this.tasks.sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    if (a.priority !== b.priority) return (priorityOrder[b.priority] || 1) - (priorityOrder[a.priority] || 1);
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });
            }
            
            getTasksByCategory(category) {
                if (category === 'all') return this.getAllTasks();
                return this.tasks.filter(t => t.category === category)
                    .sort((a, b) => {
                        if (a.completed !== b.completed) return a.completed ? 1 : -1;
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        if (a.priority !== b.priority) return (priorityOrder[b.priority] || 1) - (priorityOrder[a.priority] || 1);
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    });
            }
            
            addTask(title, url, context, category, deadline, time, priority = 'medium', tags = []) {
                const task = {
                    id: this.nextId++,
                    title,
                    url: url || null,
                    context,
                    category,
                    deadline: deadline || null,
                    time: time || null,
                    priority,
                    tags: tags || [],
                    completed: false,
                    createdAt: new Date().toISOString(),
                    completedAt: null
                };
                this.tasks.push(task);
                this.addToUndoStack('ADD_TASK', { task: { ...task } });
                this.saveTasks();
                return task;
            }
            
            updateTask(id, updates) {
                const taskIndex = this.tasks.findIndex(t => t.id === id);
                if (taskIndex === -1) return null;
                
                const oldTask = { ...this.tasks[taskIndex] };
                this.tasks[taskIndex] = { ...this.tasks[taskIndex], ...updates };
                this.addToUndoStack('UPDATE_TASK', { oldTask, newTask: { ...this.tasks[taskIndex] } });
                this.saveTasks();
                return this.tasks[taskIndex];
            }
            
            toggleComplete(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    const oldState = { ...task };
                    task.completed = !task.completed;
                    task.completedAt = task.completed ? new Date().toISOString() : null;
                    this.addToUndoStack('TOGGLE_COMPLETE', { taskId: id, oldState });
                    this.saveTasks();
                }
                return task;
            }
            
            deleteTask(id) {
                const taskIndex = this.tasks.findIndex(t => t.id === id);
                if (taskIndex !== -1) {
                    const deletedTask = this.tasks[taskIndex];
                    this.tasks = this.tasks.filter(t => t.id !== id);
                    this.addToUndoStack('DELETE_TASK', { task: deletedTask, index: taskIndex });
                    this.saveTasks();
                    return true;
                }
                return false;
            }
            
            undo() {
                if (this.undoStack.length === 0) return null;
                
                const lastAction = this.undoStack.pop();
                this.saveUndoStack();
                
                switch (lastAction.action) {
                    case 'ADD_TASK':
                        this.tasks = this.tasks.filter(t => t.id !== lastAction.data.task.id);
                        break;
                    case 'DELETE_TASK':
                        this.tasks.splice(lastAction.data.index, 0, lastAction.data.task);
                        break;
                    case 'UPDATE_TASK':
                        const taskIndex = this.tasks.findIndex(t => t.id === lastAction.data.oldTask.id);
                        if (taskIndex !== -1) {
                            this.tasks[taskIndex] = lastAction.data.oldTask;
                        }
                        break;
                    case 'TOGGLE_COMPLETE':
                        const task = this.tasks.find(t => t.id === lastAction.data.taskId);
                        if (task) {
                            Object.assign(task, lastAction.data.oldState);
                        }
                        break;
                }
                
                this.saveTasks();
                return lastAction;
            }
            
            getStats() {
                const total = this.tasks.length;
                const completed = this.tasks.filter(t => t.completed).length;
                const pending = total - completed;
                const now = new Date();
                const overdue = this.tasks.filter(t => 
                    !t.completed && t.deadline && new Date(t.deadline) < now
                ).length;
                const today = this.tasks.filter(t => 
                    !t.completed && t.deadline && 
                    new Date(t.deadline).toDateString() === now.toDateString()
                ).length;
                return { total, pending, completed, overdue, today };
            }
            
            exportData() {
                return JSON.stringify({
                    tasks: this.tasks,
                    settings: this.settings,
                    exported: new Date().toISOString()
                }, null, 2);
            }
            
            importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    if (data.tasks && Array.isArray(data.tasks)) {
                        this.tasks = data.tasks;
                        this.nextId = Math.max(...this.tasks.map(t => t.id), 0) + 1;
                        if (data.settings) {
                            this.settings = { ...this.settings, ...data.settings };
                        }
                        this.saveTasks();
                        this.saveSettings();
                        return true;
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                }
                return false;
            }
        }
        
        const storage = new TaskStorage();
        
        // Enhanced shared content handler
        function handleSharedContent() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check all possible URL parameters including iPhone shortcut format
            let sharedUrl = urlParams.get('url') || urlParams.get('text') || urlParams.get('u') || urlParams.get('link') || urlParams.get('task');
            const sharedTitle = urlParams.get('title') || urlParams.get('subject') || urlParams.get('name') || '';
            
            // Handle URL-encoded parameters (from iPhone shortcuts)
            if (sharedUrl) {
                try {
                    sharedUrl = decodeURIComponent(sharedUrl);
                } catch (e) {
                    // If decoding fails, use the original URL
                    console.log('URL decoding failed, using original:', sharedUrl);
                }
            }
            
            console.log('ðŸ” Checking shared content:', {
                url: sharedUrl,
                title: sharedTitle,
                allParams: Object.fromEntries(urlParams.entries()),
                fullUrl: window.location.href,
                decodedUrl: sharedUrl
            });
            
            if (sharedUrl) {
                // Determine category
                let category = 'link';
                const lowerUrl = sharedUrl.toLowerCase();
                
                if (lowerUrl.includes('youtube.com') || lowerUrl.includes('youtu.be') || 
                    lowerUrl.includes('vimeo.com') || lowerUrl.includes('tiktok.com')) {
                    category = 'video';
                } else if (lowerUrl.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i)) {
                    category = 'image';
                } else if (lowerUrl.includes('medium.com') || lowerUrl.includes('substack.com') ||
                          lowerUrl.includes('blog') || lowerUrl.includes('article')) {
                    category = 'article';
                }
                
                // Create title
                let title = sharedTitle;
                if (!title) {
                    try {
                        const urlObj = new URL(sharedUrl);
                        title = `Shared from ${urlObj.hostname}`;
                    } catch (e) {
                        title = 'Shared content';
                    }
                }
                
                // Add task with appropriate context based on source
                const context = urlParams.get('task') ? 'Added via iPhone shortcut' : 'Shared via web share';
                const tags = urlParams.get('task') ? ['shortcut'] : ['shared'];
                const task = storage.addTask(title, sharedUrl, context, category, null, null, 'medium', tags);
                
                // Clear URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
                
                return { title, url: sharedUrl, category, task, source: urlParams.get('task') ? 'shortcut' : 'share' };
            }
            
            return null;
        }
        
        // URL Detection from Clipboard
        function detectUrlFromText(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            return matches ? matches[0] : null;
        }
        
        // Safari-compatible clipboard handler
        async function handleSafariClipboard(onUrlDetected) {
            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    // Modern clipboard API
                    const text = await navigator.clipboard.readText();
                    const url = detectUrlFromText(text);
                    if (url) {
                        onUrlDetected(url, text);
                        return true;
                    }
                }
            } catch (error) {
                console.log('Clipboard API not available or permission denied');
            }
            return false;
        }
        
        // Voice Recognition Component
        function VoiceInput({ onResult, onError }) {
            const [isListening, setIsListening] = useState(false);
            const recognitionRef = useRef(null);
            
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;
                    recognitionRef.current.lang = 'en-US';
                    
                    recognitionRef.current.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        onResult(transcript);
                        setIsListening(false);
                    };
                    
                    recognitionRef.current.onerror = (event) => {
                        onError(event.error);
                        setIsListening(false);
                    };
                    
                    recognitionRef.current.onend = () => {
                        setIsListening(false);
                    };
                }
            }, [onResult, onError]);
            
            const startListening = () => {
                if (recognitionRef.current) {
                    setIsListening(true);
                    recognitionRef.current.start();
                }
            };
            
            const stopListening = () => {
                if (recognitionRef.current) {
                    recognitionRef.current.stop();
                    setIsListening(false);
                }
            };
            
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                return null;
            }
            
            return e('button', {
                type: 'button',
                onClick: isListening ? stopListening : startListening,
                className: `px-3 py-2 rounded border ${isListening ? 'recording bg-red-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}`
            }, isListening ? 'ðŸŽ¤ Stop' : 'ðŸŽ¤ Speak');
        }
        
        // PWA Install Prompt
        function InstallPrompt({ show, onInstall, onDismiss }) {
            if (!show) return null;
            
            return e('div', { className: 'install-prompt bg-blue-500 text-white px-4 py-3 rounded-lg shadow-lg max-w-sm' },
                e('div', { className: 'text-sm font-medium mb-2' }, 'Install TaskVault for web sharing'),
                e('div', { className: 'text-xs mb-3' }, 'Add to home screen to share links directly to TaskVault'),
                e('div', { className: 'flex space-x-2' },
                    e('button', {
                        onClick: onInstall,
                        className: 'bg-white text-blue-500 px-3 py-1 rounded text-sm hover:bg-gray-100'
                    }, 'Install'),
                    e('button', {
                        onClick: onDismiss,
                        className: 'text-blue-200 hover:text-white px-3 py-1'
                    }, 'Later')
                )
            );
        }
        
        // Enhanced Clipboard Drop Zone with Safari support
        function ClipboardDropZone({ onUrlDetected }) {
            const [isDragOver, setIsDragOver] = useState(false);
            const [isFocused, setIsFocused] = useState(false);
            const hiddenInputRef = useRef(null);
            
            // Regular paste event handler
            const handlePaste = async (e) => {
                e.preventDefault();
                const text = e.clipboardData ? e.clipboardData.getData('text') : '';
                const url = detectUrlFromText(text);
                if (url) {
                    onUrlDetected(url, text);
                } else if (isSafari && !text) {
                    // Safari might not provide clipboard data in paste event
                    const success = await handleSafariClipboard(onUrlDetected);
                    if (!success) {
                        alert('Please try copying the URL again and clicking the "Paste from Clipboard" button');
                    }
                }
            };
            
            // Safari-specific paste button handler
            const handleSafariPaste = async () => {
                const success = await handleSafariClipboard(onUrlDetected);
                if (!success) {
                    // Fallback: focus hidden input and try manual paste
                    if (hiddenInputRef.current) {
                        hiddenInputRef.current.focus();
                        hiddenInputRef.current.value = '';
                        setTimeout(() => {
                            if (hiddenInputRef.current.value) {
                                const url = detectUrlFromText(hiddenInputRef.current.value);
                                if (url) {
                                    onUrlDetected(url, hiddenInputRef.current.value);
                                }
                            } else {
                                alert('Please copy a URL first, then click this button');
                            }
                        }, 100);
                    }
                }
            };
            
            // Hidden input paste handler for Safari fallback
            const handleHiddenInputPaste = (e) => {
                setTimeout(() => {
                    const text = e.target.value;
                    const url = detectUrlFromText(text);
                    if (url) {
                        onUrlDetected(url, text);
                        e.target.value = '';
                    }
                }, 10);
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };
            
            const handleDragLeave = () => {
                setIsDragOver(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                const text = e.dataTransfer.getData('text');
                const url = detectUrlFromText(text);
                if (url) {
                    onUrlDetected(url, text);
                }
            };
            
            const handleFocus = () => setIsFocused(true);
            const handleBlur = () => setIsFocused(false);
            
            return e('div', null,
                e('div', { 
                    className: `clipboard-area ${isDragOver ? 'dragover' : ''} ${isFocused ? 'focused' : ''}`,
                    onPaste: handlePaste,
                    onDragOver: handleDragOver,
                    onDragLeave: handleDragLeave,
                    onDrop: handleDrop,
                    onFocus: handleFocus,
                    onBlur: handleBlur,
                    tabIndex: 0
                },
                    e('p', { className: 'text-gray-600 font-medium' }, 'ðŸ“‹ Quick Add'),
                    e('p', { className: 'text-sm text-gray-500 mt-1' }, 
                        isSafari && isMobile ? 
                        'Copy URL and tap "Paste from Clipboard" button below' :
                        isSafari ?
                        'Paste URLs here (Cmd+V) or use button below' :
                        'Paste or drag URLs here to quickly add tasks'
                    ),
                    e('p', { className: 'text-xs text-gray-400 mt-2' }, 
                        isSafari ? 'Safari users: Use paste button for best experience' : 'Ctrl+V or drag and drop'
                    ),
                    
                    // Safari-specific paste button
                    isSafari && e('button', {
                        onClick: handleSafariPaste,
                        className: 'paste-button'
                    }, 'ðŸ“‹ Paste from Clipboard')
                ),
                
                // Hidden input for Safari fallback
                isSafari && e('input', {
                    ref: hiddenInputRef,
                    type: 'text',
                    className: 'safari-paste-input',
                    onPaste: handleHiddenInputPaste,
                    placeholder: 'Paste here'
                })
            );
        }
        
        // Undo Toast Component
        function UndoToast({ show, onUndo, onDismiss, actionText }) {
            useEffect(() => {
                if (show) {
                    const timer = setTimeout(onDismiss, 5000);
                    return () => clearTimeout(timer);
                }
            }, [show, onDismiss]);
            
            if (!show) return null;
            
            return e('div', { className: 'undo-toast bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-3' },
                e('span', { className: 'text-sm' }, actionText),
                e('button', {
                    onClick: onUndo,
                    className: 'bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600'
                }, 'Undo'),
                e('button', {
                    onClick: onDismiss,
                    className: 'text-gray-300 hover:text-white'
                }, 'Ã—')
            );
        }
        
        // Header Component
        function Header({ searchQuery, onSearchChange, onShowSettings }) {
            return e('div', { className: 'bg-white shadow-sm border-b p-4' },
                e('div', { className: 'flex items-center justify-between mb-4' },
                    e('div', { className: 'flex items-center space-x-3' },
                        e('h1', { className: 'text-2xl font-bold text-gray-900' }, 'TaskVault'),
                        isSafari && e('span', { className: 'text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded' }, 'Safari')
                    ),
                    e('div', { className: 'flex items-center space-x-2' },
                        e('button', {
                            onClick: onShowSettings,
                            className: 'p-2 text-gray-500 hover:text-gray-700'
                        }, 'âš™ï¸'),
                        e('div', { className: 'text-sm text-gray-500' }, 'Your Secondary Brain')
                    )
                ),
                e('input', {
                    type: 'text',
                    placeholder: 'Search tasks...',
                    value: searchQuery,
                    onChange: (e) => onSearchChange(e.target.value),
                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                })
            );
        }
        
        // Stats Component
        function StatsOverview() {
            const [stats, setStats] = useState({ total: 0, pending: 0, completed: 0, overdue: 0, today: 0 });
            
            useEffect(() => {
                setStats(storage.getStats());
            }, []);
            
            return e('div', { className: 'p-4 bg-white mx-4 mt-4 rounded-lg shadow-sm grid grid-cols-5 gap-2' },
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-lg font-bold text-blue-600' }, stats.total),
                    e('div', { className: 'text-xs text-gray-500' }, 'Total')
                ),
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-lg font-bold text-orange-600' }, stats.pending),
                    e('div', { className: 'text-xs text-gray-500' }, 'Pending')
                ),
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-lg font-bold text-green-600' }, stats.completed),
                    e('div', { className: 'text-xs text-gray-500' }, 'Done')
                ),
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-lg font-bold text-purple-600' }, stats.today),
                    e('div', { className: 'text-xs text-gray-500' }, 'Today')
                ),
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-lg font-bold text-red-600' }, stats.overdue),
                    e('div', { className: 'text-xs text-gray-500' }, 'Overdue')
                )
            );
        }
        
        // Category Tabs Component
        function CategoryTabs({ selectedCategory, onCategoryChange }) {
            const categories = [
                { id: 'all', label: 'All', icon: 'ðŸ“‹' },
                { id: 'link', label: 'Links', icon: 'ðŸ”—' },
                { id: 'video', label: 'Videos', icon: 'ðŸ“¹' },
                { id: 'image', label: 'Images', icon: 'ðŸ–¼ï¸' },
                { id: 'article', label: 'Articles', icon: 'ðŸ“„' }
            ];
            
            return e('div', { className: 'flex overflow-x-auto p-4 space-x-2' },
                ...categories.map(cat =>
                    e('button', {
                        key: cat.id,
                        onClick: () => onCategoryChange(cat.id),
                        className: `flex items-center space-x-2 px-4 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap ${
                            selectedCategory === cat.id
                                ? 'bg-blue-500 text-white'
                                : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                        }`
                    },
                        e('span', null, cat.icon),
                        e('span', null, cat.label)
                    )
                )
            );
        }
        
        // Task Item Component
        function TaskItem({ task, onToggle, onDelete, onEdit }) {
            const isOverdue = task.deadline && !task.completed && new Date(task.deadline) < new Date();
            const isToday = task.deadline && !task.completed && 
                new Date(task.deadline).toDateString() === new Date().toDateString();
            
            const priorityColors = {
                high: 'text-red-600 bg-red-100',
                medium: 'text-yellow-600 bg-yellow-100',
                low: 'text-green-600 bg-green-100'
            };
            
            return e('div', { 
                className: `task-item bg-white rounded-lg shadow-sm border p-4 mb-3 priority-${task.priority} ${
                    task.completed ? 'completed' : ''
                } ${isOverdue ? 'overdue' : ''}`
            },
                e('div', { className: 'flex items-start justify-between' },
                    e('div', { className: 'flex-1' },
                        e('div', { className: 'flex items-center space-x-2 mb-2' },
                            e('h3', { className: 'task-title font-medium text-gray-900' }, task.title),
                            e('span', { 
                                className: `px-2 py-1 rounded text-xs ${priorityColors[task.priority] || priorityColors.medium}`
                            }, task.priority?.toUpperCase() || 'MEDIUM')
                        ),
                        e('p', { className: 'text-gray-600 text-sm mb-2' }, task.context),
                        task.url && e('a', {
                            href: task.url,
                            target: '_blank',
                            rel: 'noopener noreferrer',
                            className: 'text-blue-500 text-sm hover:underline block mb-2 url-display'
                        }, task.url),
                        e('div', { className: 'flex flex-wrap items-center gap-2 mb-2' },
                            task.deadline && e('div', { 
                                className: `text-sm ${isOverdue ? 'text-red-600 font-medium' : isToday ? 'text-orange-600 font-medium' : 'text-gray-500'}`
                            },
                                'ðŸ“… ', new Date(task.deadline).toLocaleDateString(),
                                task.time && ` ${task.time}`
                            ),
                            task.tags && task.tags.map((tag, i) =>
                                e('span', { 
                                    key: i, 
                                    className: 'tag bg-blue-100 text-blue-800'
                                }, `#${tag}`)
                            )
                        )
                    ),
                    e('div', { className: 'flex flex-col items-end space-y-2 ml-4' },
                        e('button', {
                            onClick: () => onToggle(task.id),
                            className: `px-3 py-1 rounded text-sm transition-colors ${
                                task.completed
                                    ? 'bg-green-100 text-green-800'
                                    : 'bg-gray-100 text-gray-800 hover:bg-blue-100 hover:text-blue-800'
                            }`
                        }, task.completed ? 'âœ“ Done' : 'Mark Done'),
                        e('div', { className: 'flex space-x-1' },
                            e('button', {
                                onClick: () => onEdit(task),
                                className: 'px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs hover:bg-blue-200'
                            }, 'âœï¸'),
                            e('button', {
                                onClick: () => onDelete(task.id),
                                className: 'px-2 py-1 bg-red-100 text-red-800 rounded text-xs hover:bg-red-200'
                            }, 'ðŸ—‘ï¸')
                        )
                    )
                )
            );
        }
        
        // Task Form Component
        function TaskForm({ task, onSave, onCancel }) {
            const [title, setTitle] = useState(task?.title || '');
            const [url, setUrl] = useState(task?.url || '');
            const [context, setContext] = useState(task?.context || '');
            const [category, setCategory] = useState(task?.category || 'link');
            const [deadline, setDeadline] = useState(task?.deadline || '');
            const [time, setTime] = useState(task?.time || '');
            const [priority, setPriority] = useState(task?.priority || 'medium');
            const [tagsInput, setTagsInput] = useState(task?.tags?.join(', ') || '');
            
            // Initialize state properly for editing
            useEffect(() => {
                if (task) {
                    setTitle(task.title || '');
                    setUrl(task.url || '');
                    setContext(task.context || '');
                    setCategory(task.category || 'link');
                    setDeadline(task.deadline || '');
                    setTime(task.time || '');
                    setPriority(task.priority || 'medium');
                    setTagsInput(task.tags?.join(', ') || '');
                }
            }, [task]);
            
            const handleVoiceResult = (transcript) => {
                if (!title && transcript.length > 0) {
                    setTitle(transcript);
                } else {
                    setContext(context + (context ? ' ' : '') + transcript);
                }
            };
            
            const handleVoiceError = (error) => {
                console.error('Voice recognition error:', error);
            };
            
            // Move URL to context function
            const moveUrlToContext = () => {
                if (url.trim()) {
                    const urlText = url.trim();
                    const newContext = context ? `${context}\n\n${urlText}` : urlText;
                    setContext(newContext);
                    setUrl('');
                }
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (title.trim()) {
                    const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
                    onSave({
                        ...(task || {}),
                        title: title.trim(),
                        url: url.trim() || null,
                        context: context.trim(),
                        category,
                        deadline: deadline || null,
                        time: time || null,
                        priority,
                        tags
                    });
                }
            };
            
            return e('div', { className: 'modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' },
                e('div', { className: 'bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto' },
                    e('h2', { className: 'text-xl font-bold mb-4' }, task ? 'Edit Task' : 'Add New Task'),
                    e('form', { onSubmit: handleSubmit },
                        e('div', { className: 'flex space-x-2 mb-3' },
                            e('input', {
                                type: 'text',
                                placeholder: 'Task title *',
                                value: title,
                                onChange: (e) => setTitle(e.target.value),
                                className: 'flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500',
                                required: true
                            }),
                            e(VoiceInput, {
                                onResult: handleVoiceResult,
                                onError: handleVoiceError
                            })
                        ),
                        e('div', { className: 'flex space-x-2 mb-3' },
                            e('input', {
                                type: 'url',
                                placeholder: 'URL (optional)',
                                value: url,
                                onChange: (e) => setUrl(e.target.value),
                                className: 'flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500'
                            }),
                            url.trim() && e('button', {
                                type: 'button',
                                onClick: moveUrlToContext,
                                className: 'px-3 py-2 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200',
                                title: 'Move URL to context notes'
                            }, 'â†“ Notes')
                        ),
                        e('div', { className: 'flex space-x-2 mb-3' },
                            e('textarea', {
                                placeholder: 'Context/Notes',
                                value: context,
                                onChange: (e) => setContext(e.target.value),
                                className: 'flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500',
                                rows: 3
                            }),
                            e('div', { className: 'flex flex-col' },
                                e(VoiceInput, {
                                    onResult: (transcript) => setContext(context + (context ? ' ' : '') + transcript),
                                    onError: handleVoiceError
                                })
                            )
                        ),
                        e('select', {
                            value: category,
                            onChange: (e) => setCategory(e.target.value),
                            className: 'w-full px-3 py-2 border border-gray-300 rounded mb-3 focus:ring-2 focus:ring-blue-500'
                        },
                            e('option', { value: 'link' }, 'ðŸ”— Link'),
                            e('option', { value: 'video' }, 'ðŸ“¹ Video'),
                            e('option', { value: 'image' }, 'ðŸ–¼ï¸ Image'),
                            e('option', { value: 'article' }, 'ðŸ“„ Article')
                        ),
                        e('select', {
                            value: priority,
                            onChange: (e) => setPriority(e.target.value),
                            className: 'w-full px-3 py-2 border border-gray-300 rounded mb-3 focus:ring-2 focus:ring-blue-500'
                        },
                            e('option', { value: 'low' }, 'ðŸŸ¢ Low Priority'),
                            e('option', { value: 'medium' }, 'ðŸŸ¡ Medium Priority'),
                            e('option', { value: 'high' }, 'ðŸ”´ High Priority')
                        ),
                        e('div', { className: 'grid grid-cols-2 gap-2 mb-3' },
                            e('input', {
                                type: 'date',
                                placeholder: 'Deadline (optional)',
                                value: deadline,
                                onChange: (e) => setDeadline(e.target.value),
                                className: 'px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500'
                            }),
                            e('input', {
                                type: 'time',
                                placeholder: 'Time (optional)',
                                value: time,
                                onChange: (e) => setTime(e.target.value),
                                className: 'px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500'
                            })
                        ),
                        e('input', {
                            type: 'text',
                            placeholder: 'Tags (comma separated)',
                            value: tagsInput,
                            onChange: (e) => setTagsInput(e.target.value),
                            className: 'w-full px-3 py-2 border border-gray-300 rounded mb-4 focus:ring-2 focus:ring-blue-500'
                        }),
                        e('div', { className: 'flex space-x-3' },
                            e('button', {
                                type: 'submit',
                                className: 'flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600'
                            }, task ? 'Update Task' : 'Add Task'),
                            e('button', {
                                type: 'button',
                                onClick: onCancel,
                                className: 'flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400'
                            }, 'Cancel')
                        )
                    )
                )
            );
        }
        
        // Settings Modal Component
        function SettingsModal({ onClose, onExport, onImport }) {
            const fileInputRef = useRef();
            
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const success = storage.importData(e.target.result);
                        alert(success ? 'Data imported successfully!' : 'Import failed. Please check the file format.');
                        if (success) window.location.reload();
                    };
                    reader.readAsText(file);
                }
            };
            
            return e('div', { className: 'modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' },
                e('div', { className: 'bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto' },
                    e('h2', { className: 'text-xl font-bold mb-4' }, 'Settings'),
                    e('div', { className: 'space-y-4' },
                        e('div', { className: 'border-t pt-4' },
                            e('h3', { className: 'font-medium mb-2' }, 'Data Management'),
                            e('div', { className: 'space-y-2' },
                                e('button', {
                                    onClick: onExport,
                                    className: 'w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600'
                                }, 'Export Data'),
                                e('button', {
                                    onClick: () => fileInputRef.current?.click(),
                                    className: 'w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600'
                                }, 'Import Data'),
                                e('input', {
                                    ref: fileInputRef,
                                    type: 'file',
                                    accept: '.json',
                                    onChange: handleImport,
                                    style: { display: 'none' }
                                })
                            )
                        )
                    ),
                    e('div', { className: 'flex space-x-3 mt-6' },
                        e('button', {
                            onClick: onClose,
                            className: 'flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400'
                        }, 'Close')
                    )
                )
            );
        }
        
        // Main App Component
        function App() {
            const [tasks, setTasks] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [showTaskForm, setShowTaskForm] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [sharedContent, setSharedContent] = useState(null);
            const [undoToast, setUndoToast] = useState({ show: false, action: null, text: '' });
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);
            
            const refreshTasks = () => {
                setTasks(storage.getTasksByCategory(selectedCategory));
            };
            
            useEffect(() => {
                // Handle shared content
                const shared = handleSharedContent();
                if (shared) {
                    setSharedContent(shared);
                    setTimeout(() => setSharedContent(null), 5000);
                }
                
                // Check for install prompt
                setTimeout(() => {
                    if (deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                        setShowInstallPrompt(true);
                    }
                }, 3000);
                
                refreshTasks();
            }, [selectedCategory]);
            
            const filteredTasks = tasks.filter(task =>
                task.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                task.context.toLowerCase().includes(searchQuery.toLowerCase()) ||
                (task.tags && task.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase())))
            );
            
            const showUndoToast = (actionText) => {
                setUndoToast({ show: true, text: actionText });
            };
            
            const handleUndo = () => {
                const undone = storage.undo();
                if (undone) {
                    refreshTasks();
                    setUndoToast({ show: false, text: '' });
                }
            };
            
            const handleInstallApp = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`PWA install outcome: ${outcome}`);
                    deferredPrompt = null;
                }
                setShowInstallPrompt(false);
            };
            
            const handleSaveTask = (taskData) => {
                if (editingTask) {
                    storage.updateTask(editingTask.id, taskData);
                    showUndoToast('Task updated');
                } else {
                    storage.addTask(
                        taskData.title,
                        taskData.url,
                        taskData.context,
                        taskData.category,
                        taskData.deadline,
                        taskData.time,
                        taskData.priority,
                        taskData.tags
                    );
                    showUndoToast('Task added');
                }
                refreshTasks();
                setShowTaskForm(false);
                setEditingTask(null);
            };
            
            const handleToggleTask = (id) => {
                const task = storage.tasks.find(t => t.id === id);
                storage.toggleComplete(id);
                showUndoToast(task?.completed ? 'Task marked incomplete' : 'Task completed');
                refreshTasks();
            };
            
            const handleDeleteTask = (id) => {
                if (confirm('Are you sure you want to delete this task?')) {
                    storage.deleteTask(id);
                    showUndoToast('Task deleted');
                    refreshTasks();
                }
            };
            
            const handleEditTask = (task) => {
                setEditingTask(task);
                setShowTaskForm(true);
            };
            
            const handleExport = () => {
                const data = storage.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taskvault-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const handleQuickAdd = (url, text) => {
                // Determine category
                let category = 'link';
                const lowerUrl = url.toLowerCase();
                
                if (lowerUrl.includes('youtube.com') || lowerUrl.includes('youtu.be') || 
                    lowerUrl.includes('vimeo.com') || lowerUrl.includes('tiktok.com')) {
                    category = 'video';
                } else if (lowerUrl.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i)) {
                    category = 'image';
                } else if (lowerUrl.includes('medium.com') || lowerUrl.includes('substack.com') ||
                          lowerUrl.includes('blog') || lowerUrl.includes('article')) {
                    category = 'article';
                }
                
                // Create title
                let title;
                try {
                    const urlObj = new URL(url);
                    title = `Quick add from ${urlObj.hostname}`;
                } catch (e) {
                    title = 'Quick add';
                }
                
                // Add task
                storage.addTask(title, url, 'Added via clipboard/drag-drop', category, null, null, 'medium', ['quick-add']);
                showUndoToast('Task added from clipboard');
                refreshTasks();
            };
            
            return e('div', { className: 'min-h-screen bg-gray-50 pb-20' },
                e(Header, { 
                    searchQuery, 
                    onSearchChange: setSearchQuery,
                    onShowSettings: () => setShowSettings(true)
                }),
                
                // Shared content notification
                sharedContent && e('div', { className: 'mx-4 mt-4 p-3 bg-green-100 border border-green-300 rounded-lg' },
                    e('p', { className: 'text-green-800 text-sm font-medium' },
                        `âœ… Added ${sharedContent.source === 'shortcut' ? 'via iPhone shortcut' : 'shared'} ${sharedContent.category}: "${sharedContent.title}"`
                    ),
                    sharedContent.url && e('p', { className: 'text-green-700 text-xs mt-1 truncate' }, sharedContent.url)
                ),
                
                e(StatsOverview),
                
                // Quick Add Area
                e('div', { className: 'px-4 mb-4' },
                    e(ClipboardDropZone, { onUrlDetected: handleQuickAdd })
                ),
                
                e(CategoryTabs, { selectedCategory, onCategoryChange: setSelectedCategory }),
                
                // Task List
                e('div', { className: 'px-4' },
                    filteredTasks.length === 0
                        ? e('div', { className: 'text-center text-gray-500 py-8' },
                            searchQuery
                                ? 'No tasks match your search.'
                                : selectedCategory === 'all'
                                    ? 'No tasks yet. Add your first task!'
                                    : `No ${selectedCategory} tasks yet.`
                        )
                        : filteredTasks.map(task =>
                            e(TaskItem, {
                                key: task.id,
                                task,
                                onToggle: handleToggleTask,
                                onDelete: handleDeleteTask,
                                onEdit: handleEditTask
                            })
                        )
                ),
                
                // Floating Add Button
                e('button', {
                    onClick: () => setShowTaskForm(true),
                    className: 'floating-add w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 flex items-center justify-center text-2xl'
                }, '+'),
                
                // Install Prompt
                e(InstallPrompt, {
                    show: showInstallPrompt,
                    onInstall: handleInstallApp,
                    onDismiss: () => setShowInstallPrompt(false)
                }),
                
                // Undo Toast
                e(UndoToast, {
                    show: undoToast.show,
                    actionText: undoToast.text,
                    onUndo: handleUndo,
                    onDismiss: () => setUndoToast({ show: false, text: '' })
                }),
                
                // Modals
                (showTaskForm || editingTask) && e(TaskForm, {
                    task: editingTask,
                    onSave: handleSaveTask,
                    onCancel: () => {
                        setShowTaskForm(false);
                        setEditingTask(null);
                    }
                }),
                
                showSettings && e(SettingsModal, {
                    onClose: () => setShowSettings(false),
                    onExport: handleExport,
                    onImport: () => {}
                })
            );
        }
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
        
        // Render the app
        ReactDOM.render(e(App), document.getElementById('root'));
    </script>
</body>
</html>